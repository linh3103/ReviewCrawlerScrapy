<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Scrapyd Runner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-7">
                <div class="card">
                    <div class="card-header">
                        <h3>Run Scrapy Spider</h3>
                    </div>
                    <div class="card-body">
                        <!-- NEW: Source Type Selection -->
                        <div class="mb-4">
                            <label class="form-label">Input Method</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sourceType" id="sourceManual" value="manual" checked>
                                <label class="form-check-label" for="sourceManual">Enter Details Manually</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sourceType" id="sourceGoogleSheet" value="google_sheet">
                                <label class="form-check-label" for="sourceGoogleSheet">Provide a Google Sheet Link</label>
                            </div>
                        </div>

                        <!-- === Google Sheet Controls (hidden by default) === -->
                        <div id="googleSheetControls" style="display: none;">
                            <div class="mb-3">
                                <label for="sheetUrl" class="form-label">Google Sheet URL</label>
                                <input type="text" id="sheetUrl" class="form-control" placeholder="Enter public Google Sheet URL">
                            </div>
                        </div>

                        <!-- === Manual Input Controls (visible by default) === -->
                        <div id="manualControls">
                            <div class="mb-3">
                                <label for="site" class="form-label">Site</label>
                                <select id="site" class="form-select">
                                    <option value="" selected disabled>-- Choose a site --</option>
                                    <option value="naver">Naver</option>
                                    <option value="coupang">Coupang</option>
                                    <option value="ohouse">Ohou.se</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="brandSearch" class="form-label">Search Naver's Brand</label>
                                <input type="text" id="brandSearch" class="form-control" placeholder="Type to filter brands..." disabled>
                            </div>

                            <div class="mb-3">
                                <label for="brand" class="form-label">Brand</label>
                                <select id="brand" class="form-select" disabled>
                                    <option value="" selected disabled>-- Choose a brand --</option>
                                    {% for brand_name, brand_url in naver_brands_data.items() %}
                                        <option value="{{ brand_name }}">{{ brand_name }} ({{ brand_url }})</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Only enabled for Naver.</div>
                            </div>

                            <div class="mb-3">
                                <label for="productId" class="form-label">Product ID / Keyword</label>
                                <input type="text" id="productId" class="form-control" placeholder="Enter Product ID or a search term">
                            </div>
                        </div>

                        <!-- Common Run Button -->
                        <hr>
                        <button id="runButton" type="button" class="btn btn-primary w-100 mt-3">Run Spider</button>
                        
                        <div id="result" class="mt-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Lấy các Element ---
        const sourceManualRadio = document.getElementById('sourceManual');
        const sourceSheetRadio = document.getElementById('sourceGoogleSheet');
        const googleSheetControls = document.getElementById('googleSheetControls');
        const manualControls = document.getElementById('manualControls');
        const runButton = document.getElementById('runButton');
        const resultDiv = document.getElementById('result');

        // --- Logic ẩn/hiện các phần giao diện ---
        function toggleControls() {
            if (sourceSheetRadio.checked) {
                googleSheetControls.style.display = 'block';
                manualControls.style.display = 'none';
            } else {
                googleSheetControls.style.display = 'none';
                manualControls.style.display = 'block';
            }
        }
        sourceManualRadio.addEventListener('change', toggleControls);
        sourceSheetRadio.addEventListener('change', toggleControls);

        // --- Logic của Manual Controls ---
        const siteSelect = document.getElementById('site');
        const brandSearchInput = document.getElementById('brandSearch');
        const brandSelect = document.getElementById('brand');
        siteSelect.addEventListener('change', function() { /* ... code cũ của bạn ... */ });
        brandSearchInput.addEventListener('input', function() { /* ... code cũ của bạn ... */ });

        // --- Logic chung cho nút Run ---
        runButton.addEventListener('click', function() {
            resultDiv.innerHTML = `<div class="alert alert-info">Sending request to Scrapyd...</div>`;
            runButton.disabled = true;

            if (sourceManualRadio.checked) {
                runManualSpider();
            } else {
                runSheetSpider();
            }
        });
        
        // --- Hàm gọi spider con (Manual) ---
        function runManualSpider() {
            const site = siteSelect.value;
            const brand = brandSelect.value;
            const productId = document.getElementById('productId').value.trim();

            // validation...
            if (!site) { alert('Please select a site.'); runButton.disabled = false; return; }
            if (site === 'naver' && !brand) { alert('Please select a brand for Naver.'); runButton.disabled = false; return; }
            if (!productId) { alert('Please enter a Product ID or Keyword.'); runButton.disabled = false; return; }

            fetch('/run-spider', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ site, brand, product_id: productId })
            })
            .then(res => res.json()).then(handleResponse).catch(handleError).finally(() => runButton.disabled = false);
        }

        // --- Hàm gọi spider product_list (Google Sheet) ---
        function runSheetSpider() {
            const sheetUrl = document.getElementById('sheetUrl').value.trim();

            if (!sheetUrl) {
                alert('Please enter a Google Sheet URL.');
                runButton.disabled = false;
                return;
            }

            fetch('/run-sheet-spider', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sheet_url: sheetUrl })
            })
            .then(res => res.json()).then(handleResponse).catch(handleError).finally(() => runButton.disabled = false);
        }

        // --- Hàm xử lý kết quả chung ---
        function handleResponse(data) {
            if (data.status === 'success') {
                const details = data.details;
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>Job scheduled successfully!</strong><br>
                        Project: ${details.project}<br>
                        Spider: ${details.spider}<br>
                        Job ID: ${details.jobid}
                    </div>`;
            } else {
                resultDiv.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${data.message}</div>`;
            }
        }
        function handleError(error) {
            resultDiv.innerHTML = `<div class="alert alert-danger">Network error: ${error}</div>`;
        }

        // Sao chép lại các hàm JS cũ của bạn vào đây
        siteSelect.addEventListener('change', function() {
            const isNaver = this.value === 'naver';
            brandSearchInput.disabled = !isNaver;
            brandSelect.disabled = !isNaver;
            if (!isNaver) { brandSearchInput.value = ''; brandSelect.value = ''; filterBrands(); }
        });
        function filterBrands() {
            const searchTerm = brandSearchInput.value.toLowerCase();
            const options = brandSelect.getElementsByTagName('option');
            for (const option of options) {
                if (option.value === "") { option.style.display = ''; continue; }
                const optionText = option.textContent.toLowerCase();
                option.style.display = optionText.includes(searchTerm) ? '' : 'none';
            }
        }
        brandSearchInput.addEventListener('input', filterBrands);
    </script>
</body>
</html>